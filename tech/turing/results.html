<!--
Generated by google gemini

prompts:

ok, now make another app to collate and rank these results. app should have an input field for the ranking logs (will be the concatenation of a bunch of student logs), should be rank button to run when all logs are pasted in together. app should show each submission (these will come in the new list of objects format). for each submission, should show contents, prompts used, tool used, content char length, prompt char length, vote stats (wins and comparisons), win percentage, and elo ranking. should order submissions from top elo to bottom. actually, ammendment to the submission structure: { id: string, content: (string around 600 chars, multi line), type: ("human" | "ai"), tool: string, prompts: (string, multi-line) }, only including tool and prompts if type is ai. maybe color code human vs ai responses

looks good, increase font size for submission content a bit, show cards (will starting stats) before logs are pasted in. there will be roughly 20 submissions and around 500 rankings (single log entries). does elo have a learning rate? should we adjust it? scores seem similar for all
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Turing Test Results & Ranking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .human-card {
        background-color: #e0f2fe; /* Light blue */
        border-left: 5px solid #3b82f6; /* Blue */
      }
      .ai-card {
        background-color: #f3f4f6; /* Light gray */
        border-left: 5px solid #6b7280; /* Gray */
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 p-4 md:p-8">
    <div class="w-full max-w-6xl mx-auto">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">Submission Ranking</h1>
        <p class="text-gray-600 mt-2">
          Paste the combined logs below to calculate win rates and Elo rankings.
        </p>
      </header>

      <!-- Input Section -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <label
          for="log-input"
          class="block text-lg font-semibold text-gray-700 mb-2"
          >Paste Combined Logs Here:</label
        >
        <textarea
          id="log-input"
          rows="10"
          class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          placeholder="sub001,sub002&#10;sub004,sub003&#10;..."
        ></textarea>
        <button
          id="rank-button"
          class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg text-xl"
        >
          Collate & Rank Results
        </button>
      </div>

      <!-- Results Section -->
      <main id="results-container">
        <!-- Results will be dynamically inserted here -->
        <div class="text-center text-gray-500">
          <p>
            Results will be displayed here after you paste the logs and click
            the button above.
          </p>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // --- UI Elements ---
        const logInputEl = document.getElementById("log-input");
        const rankButton = document.getElementById("rank-button");
        const resultsContainer = document.getElementById("results-container");

        const response = await fetch("./submissions.json");
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const submissionsData = await response.json();

        // --- Functions ---

        /**
         * Calculates the new Elo rating for two players.
         * @param {number} ratingA - Player A's current rating.
         * @param {number} ratingB - Player B's current rating.
         * @param {number} scoreA - Player A's score (1 for win, 0 for loss).
         * @param {number} kFactor - The K-factor (how much ratings change).
         * @returns {Array<number>} - The new ratings for Player A and Player B.
         */
        function calculateElo(ratingA, ratingB, scoreA, kFactor = 32) {
          const expectedScoreA =
            1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
          const expectedScoreB = 1 - expectedScoreA;
          const scoreB = 1 - scoreA;

          const newRatingA = ratingA + kFactor * (scoreA - expectedScoreA);
          const newRatingB = ratingB + kFactor * (scoreB - expectedScoreB);

          return [newRatingA, newRatingB];
        }

        /**
         * Main function to process logs and rank submissions.
         */
        function processAndRank() {
          const logs = logInputEl.value.trim().split("\n");
          if (logs.length === 0 || !logs[0]) {
            resultsContainer.innerHTML =
              '<div class="text-center text-red-500">Please paste some log data first.</div>';
            return;
          }

          // 1. Initialize stats for each submission
          const stats = {};
          submissionsData.forEach((sub) => {
            stats[sub.id] = {
              ...sub, // Copy all original data
              wins: 0,
              losses: 0,
              elo: 1000, // Starting Elo
            };
          });

          // 2. Process each log entry to calculate wins/losses and Elo
          logs.forEach((line) => {
            const ids = line.split(",").map((id) => id.trim());
            if (ids.length !== 2) return; // Skip malformed lines

            const [winnerId, loserId] = ids;

            if (stats[winnerId] && stats[loserId]) {
              // Update wins and losses
              stats[winnerId].wins++;
              stats[loserId].losses++;

              // Update Elo ratings
              const [newWinnerElo, newLoserElo] = calculateElo(
                stats[winnerId].elo,
                stats[loserId].elo,
                1, // Winner's score is 1
              );
              stats[winnerId].elo = newWinnerElo;
              stats[loserId].elo = newLoserElo;
            }
          });

          // 3. Convert stats object to an array and calculate final metrics
          const rankedResults = Object.values(stats).map((stat) => {
            const comparisons = stat.wins + stat.losses;
            const winPercentage =
              comparisons > 0 ? (stat.wins / comparisons) * 100 : 0;
            return {
              ...stat,
              comparisons,
              winPercentage,
            };
          });

          // 4. Sort results by Elo rating (descending)
          rankedResults.sort((a, b) => b.elo - a.elo);

          // 5. Display the results
          displayResults(rankedResults);
        }

        /**
         * Renders the ranked results to the DOM.
         * @param {Array<object>} results - The sorted array of submission stats.
         */
        function displayResults(results) {
          resultsContainer.innerHTML = ""; // Clear previous results

          if (results.length === 0) {
            resultsContainer.innerHTML =
              '<div class="text-center text-gray-500"><p>No submission data found.</p></div>';
            return;
          }

          results.forEach((sub, index) => {
            const cardClass = sub.type === "human" ? "human-card" : "ai-card";
            const promptSection =
              sub.type === "ai"
                ? `
                        <div class="mt-4 pt-4 border-t border-gray-300">
                            <h4 class="font-semibold text-gray-600">Tool: <span class="font-normal text-gray-800">${sub.tool || "N/A"}</span></h4>
                            <h4 class="font-semibold text-gray-600 mt-1">Prompt (${sub.prompts?.length || 0} chars):</h4>
                            <p class="text-sm text-gray-700 bg-gray-100 p-2 rounded mt-1 whitespace-pre-wrap">${sub.prompts || "N/A"}</p>
                        </div>
                    `
                : "";

            const cardHTML = `
                        <div class="p-6 rounded-lg shadow-md mb-6 ${cardClass}">
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                                <!-- Rank and Type -->
                                <div class="md:col-span-1 text-center">
                                    <div class="text-4xl font-bold text-gray-800">${index + 1}</div>
                                    <div class="text-xs font-bold uppercase tracking-wider ${sub.type === "human" ? "text-blue-600" : "text-gray-600"}">${sub.type}</div>
                                </div>

                                <!-- Content and Prompts -->
                                <div class="md:col-span-7">
                                    <h3 class="font-bold text-lg mb-1">ID: <span class="font-mono">${sub.id}</span></h3>
                                    <p class="text-gray-800 whitespace-pre-wrap text-base leading-relaxed">${sub.content}</p>
                                    ${promptSection}
                                </div>

                                <!-- Stats -->
                                <div class="md:col-span-4 bg-white/50 p-4 rounded-md">
                                    <h4 class="text-lg font-bold text-center mb-3">Stats</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="font-semibold text-gray-600">Elo Rating:</span>
                                            <span class="font-bold text-xl text-blue-700">${Math.round(sub.elo)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold text-gray-600">Vote Stats:</span>
                                            <span class="font-mono">${sub.wins} wins / ${sub.comparisons} comps</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold text-gray-600">Win Rate:</span>
                                            <span class="font-mono">${sub.winPercentage.toFixed(1)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold text-gray-600">Content Length:</span>
                                            <span class="font-mono">${sub.content.length} chars</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            resultsContainer.innerHTML += cardHTML;
          });
        }

        /**
         * Displays the initial state of all submissions before ranking.
         */
        function displayInitialState() {
          const initialResults = submissionsData.map((sub) => ({
            ...sub,
            wins: 0,
            losses: 0,
            comparisons: 0,
            winPercentage: 0,
            elo: 1000, // Starting Elo
          }));

          // Sort by ID for a consistent initial order
          initialResults.sort((a, b) => a.id.localeCompare(b.id));

          displayResults(initialResults);
        }

        // --- Event Listeners ---
        rankButton.addEventListener("click", processAndRank);

        // --- Initial Load ---
        displayInitialState();
      });
    </script>
  </body>
</html>
